<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sparklight Offer Management</title>

  <!-- SheetJS for XLSX import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --brand: #0284c7;
      --brand-dark: #0369a1;
      --line: #e2e8f0;
      --good: #16a34a;
      --bad: #dc2626;
      --accent: #d32f2f;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 1150px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 12px; color: var(--brand-dark); font-weight: 800; letter-spacing: -0.02em; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 6px 20px rgba(2,8,23,.05); padding: 20px; margin-bottom: 18px; }
    .grid { display: grid; gap: 14px; grid-template-columns: repeat(12, 1fr); }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
    label { font-size: 12px; text-transform: uppercase; color: var(--muted); letter-spacing: .06em; display: block; margin-bottom: 4px; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 10px; font-size: 14px; background: #fff;
    }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .hint { font-size: 12px; color: var(--muted); }
    .btn { appearance: none; border: none; background: var(--brand); color: #fff; font-weight: 700; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
    .btn:hover { background: var(--brand-dark); }
    .btn.secondary { background: #0ea5e9; } .btn.secondary:hover{ background:#0284c7; }
    .btn.ghost { background: transparent; color: var(--brand-dark); border: 1px solid var(--line); }
    .btn.danger { background: var(--bad); } .btn.success { background: var(--good); }
    table { width: 100%; border-collapse: collapse; border: 1px solid var(--line); overflow: auto; border-radius: 12px; }
    th, td { border-bottom: 1px solid var(--line); padding: 10px 12px; text-align: left; font-size: 14px; vertical-align: top; }
    thead th { background: #e0f2fe; position: sticky; top: 0; z-index: 1; }
    .chip { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); display: inline-block; }
    .right { display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap; }
    .hide { display: none; }
    .hr { height:1px; background:var(--line); margin:10px 0 2px; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(2,8,23,.44); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 1000; }
    .modal { max-width: 900px; width: 100%; background: #fff; border-radius: 14px; box-shadow: 0 20px 50px rgba(2,8,23,.25); }
    .modal header { padding: 14px 16px; border-bottom: 1px solid var(--line); display:flex; justify-content: space-between; align-items:center; }
    .modal header h3 { margin:0; font-size: 18px; }
    .modal .content { padding: 16px; display: grid; gap: 16px; grid-template-columns: 1fr 1fr; }
    .modal .section { border:1px solid var(--line); border-radius: 10px; padding: 12px; }
    .modal footer { padding: 14px 16px; border-top: 1px solid var(--line); display:flex; justify-content:flex-end; gap: 10px; }
    .hilite { color: var(--accent); font-weight: 700; }
    .x { cursor:pointer; color:#64748b; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üí° Sparklight Offer Management</h1>

    <!-- FORM -->
    <div class="card">
      <form id="offerForm">
        <div class="grid">

          <!-- Core Enhanced -->
          <div class="col-6">
            <label>Core Enhanced</label>
            <select id="coreEnhanced"></select>
            <div id="coreEnhancedNewWrap" class="hide" style="margin-top:8px;">
              <input type="text" id="coreEnhancedNew" placeholder="Enter new Core Enhanced value">
              <div class="row" style="margin-top:6px;">
                <label class="row" style="gap:6px; color:#dc2626;">
                  <input type="checkbox" id="coreEnhancedSavePerm">
                  Save this new Core Enhanced value for future offers.
                </label>
              </div>
            </div>
          </div>

          <!-- Fiber checkbox replaces Type; sets Type internally and auto Fiber disclaimer -->
          <div class="col-3">
            <label>Fiber</label>
            <div class="row">
              <input type="checkbox" id="fiberCheck">
              <span class="hint">Unchecked = HFC</span>
            </div>
          </div>

          <div class="col-3">
            <label>Campaign</label>
            <input type="text" id="campaign" placeholder="e.g., BFCM (11/28‚Äì12/5)" required>
          </div>

          <div class="col-12">
            <label>Offer (headline)</label>
            <input type="text" id="offer" placeholder="e.g., 600 Mbps for $29.95/mo. for 6 mos.">
          </div>

          <div class="col-3">
            <label>Download Speed</label>
            <input type="text" id="down" placeholder="e.g., 600 Mbps">
          </div>
          <div class="col-3">
            <label>Upload Speed</label>
            <input type="text" id="up" placeholder="e.g., 40 Mbps">
          </div>
          <div class="col-3">
            <label>Promo Price</label>
            <input type="text" id="promo" placeholder="$29.95">
          </div>
          <div class="col-3">
            <label>Term (months)</label>
            <input type="text" id="term" placeholder="6">
          </div>

          <!-- Gift Card -->
          <div class="col-3">
            <label>Gift Card</label>
            <div class="row">
              <input type="checkbox" id="gcCheck">
              <input type="text" id="gcAmt" class="hide" placeholder="$50">
            </div>
            <div class="hint">Check to enable amount</div>
          </div>

          <!-- Step-Up -->
          <div class="col-3">
            <label>Step-Up Term</label>
            <div class="row">
              <input type="checkbox" id="suTermCheck">
              <input type="text" id="suTerm" class="hide" placeholder="7‚Äì12 mos">
            </div>
          </div>
          <div class="col-3">
            <label>Step-Up Price</label>
            <div class="row">
              <input type="checkbox" id="suPriceCheck">
              <input type="text" id="suPrice" class="hide" placeholder="$59.95">
            </div>
          </div>
          <div class="col-3">
            <label>Reg Rate</label>
            <input type="text" id="reg" placeholder="$75‚Äì$90">
          </div>

          <div class="col-4">
            <label>Equip Inclu.</label>
            <select id="equip">
              <option value="">‚Äî</option>
              <option>No</option>
              <option>eero</option>
              <option>eero Pro 6E</option>
              <option>Plume</option>
            </select>
          </div>

          <!-- Disclaimers: only eero/Plume and Ookla shown. Fiber is auto from Fiber checkbox -->
          <div class="col-8">
            <div class="row" style="margin-top:22px;">
              <label class="row" style="gap:6px;"><input type="checkbox" id="discEero"> eero/Plume Disclaimer</label>
              <label class="row" style="gap:6px;"><input type="checkbox" id="discOokla"> Ookla Disclaimer</label>
            </div>
          </div>

          <!-- Expiration + Unlimited Data -->
          <div class="col-4">
            <label>Offer Expiration</label>
            <input type="date" id="expires">
            <div class="hint">Optional; leave blank to omit.</div>
          </div>
          <div class="col-4">
            <label>Unlimited Data</label>
            <div class="row">
              <input type="checkbox" id="unlimitedCheck" checked>
              <span class="hint">Checked = include ‚ÄúIncludes Unlimited data plan.‚Äù</span>
            </div>
          </div>

          <div class="col-12 hr"></div>

          <div class="col-6">
            <label>Short Disclaimer (base)</label>
            <input type="text" id="shortDisc" placeholder="Generate" value="Generate">
          </div>
          <div class="col-6">
            <label>Long Disclaimer (base)</label>
            <textarea id="longDisc" rows="3" placeholder="Generate">Generate</textarea>
          </div>

          <div class="col-12 row" style="justify-content:flex-end; gap:8px;">
            <button type="button" class="btn ghost" id="genBaseBtn">ü™Ñ Generate Base Disclaimers</button>
          </div>

          <div class="col-12 hr"></div>

          <!-- Status is hidden & always Not Started -->
          <input type="hidden" id="status" value="Not Started">

          <div class="col-6">
            <label>Automated Tracker</label>
            <input type="text" id="automatedTracker" readonly>
            <div class="hint">Auto-filled as Automated_Tracker_(MMDDYY)</div>
          </div>

          <div class="col-6">
            <label>Campaign Notes (optional)</label>
            <input type="text" id="proof" placeholder="">
          </div>

          <div class="col-12 right">
            <button type="button" class="btn ghost" id="resetFormBtn">Reset</button>
            <button type="submit" class="btn">Save Offer</button>
          </div>
        </div>
        <input type="hidden" id="editId" value="">
      </form>
    </div>

    <!-- ACTIONS -->
    <div class="card right">
      <button class="btn secondary" id="downloadTemplateXlsx">Download Template (XLSX)</button>
      <button class="btn secondary" id="downloadTemplateCsv">Download Template (CSV)</button>

      <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="hide">
      <button class="btn" id="importBtn">Import Data</button>

      <button class="btn secondary" id="exportCsv">Export CSV</button>
      <button class="btn success" id="exportXlsx">Export XLSX</button>
      <button class="btn ghost" id="clearAll">Clear All</button>
    </div>

    <!-- TABLE -->
    <div class="card" style="overflow:auto;">
      <table id="offersTable">
        <thead>
          <tr>
            <th>Core Enhanced</th>
            <th>Type</th>
            <th>Campaign</th>
            <th>Offer</th>
            <th>Gift Card</th>
            <th>Download</th>
            <th>Upload</th>
            <th>Promo</th>
            <th>Term</th>
            <th>Step-Up Term</th>
            <th>Step-Up Price</th>
            <th>Reg Rate</th>
            <th>Equip</th>
            <th>Short Disc</th>
            <th>Long Disc</th>
            <th>eero/Plume</th>
            <th>Fiber Fueled</th>
            <th>Ookla</th>
            <th>Expires</th>
            <th>Unlimited</th>
            <th>Status</th>
            <th>Automated Tracker</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">Preview Base Disclaimers</h3>
        <span class="x" id="modalClose">‚úï</span>
      </header>
      <div class="content">
        <div class="section">
          <strong>Short Disclaimer</strong>
          <div id="previewShort" style="margin-top:8px; line-height:1.4;"></div>
        </div>
        <div class="section">
          <strong>Long Disclaimer</strong>
          <div id="previewLong" style="margin-top:8px; line-height:1.4; white-space:pre-wrap;"></div>
        </div>
      </div>
      <footer>
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn success" id="modalApply">Apply to Offer</button>
      </footer>
    </div>
  </div>

  <script>
    /*************** IndexedDB Setup ***************/
    const DB_NAME = 'sparklight_offers_db';
    const STORE_NAME = 'offers';
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 3);
        req.onupgradeneeded = (e) => {
          const dbx = e.target.result;
          if (!dbx.objectStoreNames.contains(STORE_NAME)) {
            dbx.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          }
        };
        req.onsuccess = () => { db = req.result; resolve(); };
        req.onerror = () => reject(req.error);
      });
    }

    function dbAdd(record) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).add(record).onsuccess = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
    function dbUpdate(record) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put(record).onsuccess = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
    function dbDelete(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).delete(id).onsuccess = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
    function dbGetAll() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }
    function dbClear() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).clear().onsuccess = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    /*************** Core Enhanced Dropdown (with Add New) ***************/
    const CORE_ENHANCED_DEFAULTS = [
      "Core_FMAJ",
      "Core_NoEERO",
      "Core_Equip",
      "Core_Max_HHI",
      "Core_Max_Equip",
      "Core_Max_Exp",
      "Core_Max_Equip_Sioux",
      "Enhanced_Equip",
      "Enhanced_Max",
      "Enhanced_Max_Equip",
      "Edge",
      "Edge_Equip",
      "Edge_Max",
      "Edge_Max_VIC",
      "Add New"
    ];
    const CORE_ENHANCED_LS_KEY = 'coreEnhancedOptions';

    function getCoreEnhancedOptions() {
      const raw = localStorage.getItem(CORE_ENHANCED_LS_KEY);
      try {
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed) && parsed.length) return parsed;
      } catch {}
      return [...CORE_ENHANCED_DEFAULTS];
    }
    function setCoreEnhancedOptions(opts) {
      localStorage.setItem(CORE_ENHANCED_LS_KEY, JSON.stringify(opts));
    }
    function populateCoreEnhancedSelect(value='') {
      const sel = document.getElementById('coreEnhanced');
      const options = getCoreEnhancedOptions();
      sel.innerHTML = '';
      options.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
      if (value && options.includes(value)) {
        sel.value = value;
      } else {
        sel.value = options[0];
      }
      handleCoreEnhancedChange(sel.value);
    }
    function handleCoreEnhancedChange(val) {
      const wrap = document.getElementById('coreEnhancedNewWrap');
      if (val === 'Add New') {
        wrap.classList.remove('hide');
      } else {
        wrap.classList.add('hide');
        document.getElementById('coreEnhancedNew').value = '';
        document.getElementById('coreEnhancedSavePerm').checked = false;
      }
    }

    /*************** Helpers ***************/
    const qs = (s) => document.querySelector(s);
    const tbody = qs('#offersTable tbody');
    const form = qs('#offerForm');
    const hideEl = (el) => el.classList.add('hide');
    const showEl = (el) => el.classList.remove('hide');

    function autoFillAutomatedTracker() {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const yy = String(d.getFullYear()).slice(-2);
      qs('#automatedTracker').value = `Automated_Tracker_(${mm}${dd}${yy})`;
    }

    function resetForm() {
      form.reset();
      // reset Core Enhanced dropdown
      populateCoreEnhancedSelect();
      // set defaults
      qs('#shortDisc').value = 'Generate';
      qs('#longDisc').value = 'Generate';
      qs('#unlimitedCheck').checked = true;
      qs('#editId').value = '';
      // toggles
      hideEl(qs('#gcAmt')); hideEl(qs('#suTerm')); hideEl(qs('#suPrice'));
      qs('#gcCheck').checked = false; qs('#suTermCheck').checked = false; qs('#suPriceCheck').checked = false;
      // Core Enhanced new wrap
      handleCoreEnhancedChange(qs('#coreEnhanced').value);
      autoFillAutomatedTracker();
    }

    function currentType() {
      return qs('#fiberCheck').checked ? 'Fiber' : 'HFC';
    }
    function currentDiscFiber() {
      return qs('#fiberCheck').checked ? 'Yes' : '';
    }

    function formToRecord() {
      // Resolve Core Enhanced final value
      let coreEnhancedVal = qs('#coreEnhanced').value;
      if (coreEnhancedVal === 'Add New') {
        const custom = qs('#coreEnhancedNew').value.trim();
        if (custom) coreEnhancedVal = custom;
      }

      // Save permanently if requested
      if (qs('#coreEnhanced').value === 'Add New' && qs('#coreEnhancedSavePerm').checked) {
        const opts = getCoreEnhancedOptions();
        if (!opts.includes(coreEnhancedVal)) {
          const idxAddNew = opts.indexOf('Add New');
          if (idxAddNew >= 0) {
            opts.splice(idxAddNew, 0, coreEnhancedVal);
          } else {
            opts.push(coreEnhancedVal);
          }
          setCoreEnhancedOptions(opts);
          populateCoreEnhancedSelect(coreEnhancedVal);
        }
      }

      // Always set Automated Tracker fresh
      autoFillAutomatedTracker();

      return {
        id: qs('#editId').value ? Number(qs('#editId').value) : undefined,
        coreEnhanced: coreEnhancedVal,
        type: currentType(),
        campaign: qs('#campaign').value.trim(),
        offer: qs('#offer').value.trim(),
        giftCard: qs('#gcCheck').checked ? (qs('#gcAmt').value.trim() || 'Yes') : '',
        download: qs('#down').value.trim(),
        upload: qs('#up').value.trim(),
        promo: qs('#promo').value.trim(),
        term: qs('#term').value.trim(),
        stepUpTerm: qs('#suTermCheck').checked ? qs('#suTerm').value.trim() : '',
        stepUpPrice: qs('#suPriceCheck').checked ? qs('#suPrice').value.trim() : '',
        regRate: qs('#reg').value.trim(),
        equip: qs('#equip').value,
        shortDisc: qs('#shortDisc').value || 'Generate',
        longDisc: qs('#longDisc').value || 'Generate',
        discEero: qs('#discEero').checked ? 'Yes' : '',
        discFiber: currentDiscFiber(), // auto from Fiber checkbox
        discOokla: qs('#discOokla').checked ? 'Yes' : '',
        expires: qs('#expires').value, // yyyy-mm-dd or ''
        unlimited: qs('#unlimitedCheck').checked ? 'Yes' : '',
        status: 'Not Started',
        automatedTracker: qs('#automatedTracker').value,
        notes: qs('#proof').value.trim()
      };
    }

    function recordToRow(r) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.coreEnhanced || ''}</td>
        <td>${r.type || ''}</td>
        <td>${r.campaign || ''}</td>
        <td>${r.offer || ''}</td>
        <td>${r.giftCard || ''}</td>
        <td>${r.download || ''}</td>
        <td>${r.upload || ''}</td>
        <td>${r.promo || ''}</td>
        <td>${r.term || ''}</td>
        <td>${r.stepUpTerm || ''}</td>
        <td>${r.stepUpPrice || ''}</td>
        <td>${r.regRate || ''}</td>
        <td>${r.equip || ''}</td>
        <td>${r.shortDisc || 'Generate'}</td>
        <td>${r.longDisc || 'Generate'}</td>
        <td>${r.discEero || ''}</td>
        <td>${r.discFiber || ''}</td>
        <td>${r.discOokla || ''}</td>
        <td>${r.expires || ''}</td>
        <td>${r.unlimited || ''}</td>
        <td><span class="chip">${r.status || ''}</span></td>
        <td>${r.automatedTracker || ''}</td>
        <td>${r.notes || ''}</td>
        <td>
          <button class="btn ghost" data-edit="${r.id}">Edit</button>
          <button class="btn danger" data-del="${r.id}">Delete</button>
        </td>`;
      return tr;
    }

    async function refreshTable() {
      tbody.innerHTML = '';
      const rows = await dbGetAll();
      rows.forEach(r => tbody.appendChild(recordToRow(r)));
    }

    /*************** Listeners: UI Toggles ***************/
    qs('#gcCheck').addEventListener('change', e => e.target.checked ? showEl(qs('#gcAmt')) : hideEl(qs('#gcAmt')));
    qs('#suTermCheck').addEventListener('change', e => e.target.checked ? showEl(qs('#suTerm')) : hideEl(qs('#suTerm')));
    qs('#suPriceCheck').addEventListener('change', e => e.target.checked ? showEl(qs('#suPrice')) : hideEl(qs('#suPrice')));

    qs('#resetFormBtn').addEventListener('click', resetForm);

    document.getElementById('coreEnhanced').addEventListener('change', (e) => {
      handleCoreEnhancedChange(e.target.value);
    });

    /*************** Create / Update ***************/
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const rec = formToRecord();

      if (!rec.campaign) {
        alert('Campaign is required');
        return;
      }

      try {
        if (rec.id && !isNaN(rec.id)) {
          await dbUpdate(rec);
          console.log(`‚úÖ Offer updated (ID ${rec.id})`);
        } else {
          delete rec.id; // Let IndexedDB auto-generate the key
          await dbAdd(rec);
          console.log('‚úÖ New offer added to IndexedDB');
        }

        resetForm();
        await refreshTable();

      } catch (err) {
        console.error('‚ùå Save failed:', err);
        alert('Something went wrong while saving this record. Please try again.');
      }
    });

    /*************** Table Actions ***************/
    tbody.addEventListener('click', async (e) => {
      const editId = e.target.getAttribute('data-edit');
      const delId = e.target.getAttribute('data-del');
      if (editId) {
        const all = await dbGetAll();
        const rec = all.find(r => r.id === Number(editId));
        if (!rec) return;
        // populate form
        qs('#editId').value = rec.id;
        populateCoreEnhancedSelect(rec.coreEnhanced || '');
        if (rec.coreEnhanced && !getCoreEnhancedOptions().includes(rec.coreEnhanced)) {
          // show new wrap pre-filled (not permanent unless checked and saved)
          document.getElementById('coreEnhanced').value = 'Add New';
          handleCoreEnhancedChange('Add New');
          document.getElementById('coreEnhancedNew').value = rec.coreEnhanced;
        }
        qs('#fiberCheck').checked = (rec.type === 'Fiber');
        qs('#campaign').value = rec.campaign || '';
        qs('#offer').value = rec.offer || '';
        if (rec.giftCard) { qs('#gcCheck').checked = true; showEl(qs('#gcAmt')); qs('#gcAmt').value = rec.giftCard; } else { qs('#gcCheck').checked = false; hideEl(qs('#gcAmt')); qs('#gcAmt').value=''; }
        qs('#down').value = rec.download || '';
        qs('#up').value = rec.upload || '';
        qs('#promo').value = rec.promo || '';
        qs('#term').value = rec.term || '';
        if (rec.stepUpTerm) { qs('#suTermCheck').checked = true; showEl(qs('#suTerm')); qs('#suTerm').value = rec.stepUpTerm; } else { qs('#suTermCheck').checked = false; hideEl(qs('#suTerm')); qs('#suTerm').value=''; }
        if (rec.stepUpPrice) { qs('#suPriceCheck').checked = true; showEl(qs('#suPrice')); qs('#suPrice').value = rec.stepUpPrice; } else { qs('#suPriceCheck').checked = false; hideEl(qs('#suPrice')); qs('#suPrice').value=''; }
        qs('#reg').value = rec.regRate || '';
        qs('#equip').value = rec.equip || '';
        qs('#shortDisc').value = rec.shortDisc || 'Generate';
        qs('#longDisc').value = rec.longDisc || 'Generate';
        qs('#discEero').checked = !!rec.discEero;
        qs('#discOokla').checked = !!rec.discOokla;
        qs('#expires').value = rec.expires || '';
        qs('#unlimitedCheck').checked = rec.unlimited === 'Yes';
        qs('#automatedTracker').value = rec.automatedTracker || '';
        qs('#proof').value = rec.notes || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (delId) {
        if (confirm('Delete this record?')) {
          await dbDelete(Number(delId));
          await refreshTable();
        }
      }
    });

    /*************** Export ***************/
    const HEADERS = [
      'Core Enhanced','Type','Campaign','Offer','Gift Card','Download Speed','Upload Speed',
      'Promo Price','Term','Step-Up Term','Step-Up Price','Reg Rate','Equip Inclu.',
      'Short Disclaimer','Long Disclaimer',
      'eero/Plume Disclaimer','Fiber Fueled Disclaimer','Ookla Disclaimer',
      'Offer Expiration','Unlimited Data','Status','Automated Tracker','Notes'
    ];

    async function getAllAsRows() {
      const rows = await dbGetAll();
      return rows.map(r => ({
        "Core Enhanced": r.coreEnhanced, "Type": r.type, "Campaign": r.campaign, "Offer": r.offer,
        "Gift Card": r.giftCard, "Download Speed": r.download, "Upload Speed": r.upload,
        "Promo Price": r.promo, "Term": r.term, "Step-Up Term": r.stepUpTerm, "Step-Up Price": r.stepUpPrice,
        "Reg Rate": r.regRate, "Equip Inclu.": r.equip,
        "Short Disclaimer": r.shortDisc || 'Generate',
        "Long Disclaimer": r.longDisc || 'Generate',
        "eero/Plume Disclaimer": r.discEero, "Fiber Fueled Disclaimer": r.discFiber, "Ookla Disclaimer": r.discOokla,
        "Offer Expiration": r.expires || '', "Unlimited Data": r.unlimited || '',
        "Status": r.status, "Automated Tracker": r.automatedTracker, "Notes": r.notes
      }));
    }

    qs('#exportCsv').addEventListener('click', async () => {
      const rows = await getAllAsRows();
      const csv = [
        HEADERS.join(','),
        ...rows.map(obj => HEADERS.map(h => {
          const v = (obj[h] ?? '').toString().replace(/\r?\n/g, ' ');
          return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
        }).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'offers_export.csv';
      a.click();
    });

    qs('#exportXlsx').addEventListener('click', async () => {
      const rows = await getAllAsRows();
      const ws = XLSX.utils.json_to_sheet(rows, { header: HEADERS });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Offers');
      XLSX.writeFile(wb, 'offers_export.xlsx');
    });

    /*************** Template Download ***************/
    function downloadTemplate(asXlsx=false) {
      const templateRow = {};
      HEADERS.forEach(h => templateRow[h] = '');
      if (asXlsx) {
        const ws = XLSX.utils.json_to_sheet([templateRow], { header: HEADERS });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Template');
        XLSX.writeFile(wb, 'offers_template.xlsx');
      } else {
        const csv = [HEADERS.join(','), ''.padEnd(0)].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'offers_template.csv';
        a.click();
      }
    }
    qs('#downloadTemplateXlsx').addEventListener('click', () => downloadTemplate(true));
    qs('#downloadTemplateCsv').addEventListener('click', () => downloadTemplate(false));

    /*************** Import ***************/
    qs('#importBtn').addEventListener('click', () => qs('#importFile').click());
    qs('#importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          if (file.name.endsWith('.csv')) {
            const text = evt.target.result;
            importCSV(text);
          } else {
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
            await importRows(json);
          }
        } catch (err) {
          alert('Import failed. Ensure columns match the template.');
          console.error(err);
        } finally {
          e.target.value = '';
        }
      };
      if (file.name.endsWith('.csv')) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    });

    async function importCSV(text) {
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines[0].split(',');
      const rows = lines.slice(1).map(line => {
        const vals = [];
        let cur = '', inQ = false;
        for (let i=0;i<line.length;i++) {
          const ch = line[i];
          if (ch === '"') { inQ = !inQ; continue; }
          if (ch === ',' && !inQ) { vals.push(cur); cur=''; continue; }
          cur += ch;
        }
        vals.push(cur);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (vals[idx] || '').trim());
        return obj;
      });
      await importRows(rows);
    }

    async function importRows(objRows) {
      for (const obj of objRows) {
        const rec = {
          coreEnhanced: obj['Core Enhanced'] || '',
          type: obj['Type'] || '',
          campaign: obj['Campaign'] || '',
          offer: obj['Offer'] || '',
          giftCard: obj['Gift Card'] || '',
          download: obj['Download Speed'] || '',
          upload: obj['Upload Speed'] || '',
          promo: obj['Promo Price'] || '',
          term: obj['Term'] || '',
          stepUpTerm: obj['Step-Up Term'] || '',
          stepUpPrice: obj['Step-Up Price'] || '',
          regRate: obj['Reg Rate'] || '',
          equip: obj['Equip Inclu.'] || '',
          shortDisc: obj['Short Disclaimer'] || 'Generate',
          longDisc: obj['Long Disclaimer'] || 'Generate',
          discEero: obj['eero/Plume Disclaimer'] || '',
          discFiber: obj['Fiber Fueled Disclaimer'] || '',
          discOokla: obj['Ookla Disclaimer'] || '',
          expires: obj['Offer Expiration'] || '',
          unlimited: obj['Unlimited Data'] || '',
          status: obj['Status'] || 'Not Started',
          automatedTracker: obj['Automated Tracker'] || '',
          notes: obj['Notes'] || ''
        };
        await dbAdd(rec);
      }
      await refreshTable();
    }

    /*************** Clear All ***************/
    qs('#clearAll').addEventListener('click', async () => {
      if (!confirm('Clear ALL records?')) return;
      await dbClear();
      await refreshTable();
    });

    /*************** Base Disclaimer Generator ***************/
    const MODAL = qs('#modalBackdrop');
    const PREV_SHORT = qs('#previewShort');
    const PREV_LONG = qs('#previewLong');
    const modalOpen = () => MODAL.style.display = 'flex';
    const modalClose = () => MODAL.style.display = 'none';
    qs('#modalClose').addEventListener('click', modalClose);
    qs('#modalCancel').addEventListener('click', modalClose);

    // Utility to wrap dynamic parts (red)
    const H = (txt) => `<span class="hilite">${txt || ''}</span>`;
    const plain = (html) => { const d=document.createElement('div'); d.innerHTML=html; return d.textContent || d.innerText || ''; };
    const cleanMoney = (s) => (s || '').replace(/\s+/g,'').replace(/^\$/, '$');
    function formatDate(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return '';
      const [y,m,d] = yyyy_mm_dd.split('-').map(n=>parseInt(n,10));
      const dt = new Date(y, m-1, d);
      const opts = { year:'numeric', month:'short', day:'numeric' };
      return dt.toLocaleDateString(undefined, opts);
    }

    function buildBaseShortDisclaimer() {
      return `Auto Pay and Paperless Billing required. Equipment, taxes, surcharges and fees are not included. Restrictions apply; see disclaimer for details.`;
    }

    function buildBaseLongDisclaimer(model) {
      const {
        download, upload, promo, term, stepUpPrice, stepUpTerm,
        regRate, expires, unlimited
      } = model;

      const parts = [];

      let lead = `Promotional rate for ${H(download)} download x ${H(upload)} upload Internet service is ${H(cleanMoney(promo))}/mo. for the first ${H(term)} months`;
      if (stepUpPrice && stepUpTerm) {
        lead += `, then ${H(cleanMoney(stepUpPrice))}/mo. for months ${H(stepUpTerm)}`;
      }
      lead += ` and requires Auto Pay with checking/savings account or debit card plus paperless billing.`;
      parts.push(lead);

      if (regRate) {
        parts.push(`Regular rates from ${H(regRate)}/mo. and are subject to change at any time.`);
      }

      if (expires) {
        parts.push(`Offer expires ${H(formatDate(expires))}.`);
      }

      if (unlimited) {
        parts.push(`Includes Unlimited data plan.`);
      }

      parts.push(`Visit www.sparklight.com/legal/internet-aup for details of Sparklight‚Äôs Acceptable Use Policy.`);
      parts.push(`Equipment, taxes, surcharges, and fees are not included.`);
      parts.push(`All services are not available in all areas. Offer available to new customers only. Restrictions apply. Call for details.`);

      return parts.join(' ');
    }

    qs('#genBaseBtn').addEventListener('click', () => {
      const model = {
        download: qs('#down').value.trim() || '‚Äî',
        upload: qs('#up').value.trim() || '‚Äî',
        promo: qs('#promo').value.trim(),
        term: qs('#term').value.trim(),
        stepUpPrice: qs('#suPriceCheck').checked ? qs('#suPrice').value.trim() : '',
        stepUpTerm: qs('#suTermCheck').checked ? qs('#suTerm').value.trim() : '',
        regRate: qs('#reg').value.trim(),
        expires: qs('#expires').value,
        unlimited: qs('#unlimitedCheck').checked ? 'Yes' : ''
      };

      const previewShort = buildBaseShortDisclaimer();
      const previewLong = buildBaseLongDisclaimer(model);

      PREV_SHORT.innerHTML = previewShort;
      PREV_LONG.innerHTML = previewLong;

      PREV_SHORT.dataset.plain = plain(previewShort);
      PREV_LONG.dataset.plain = plain(previewLong);

      modalOpen();
    });

    qs('#modalApply').addEventListener('click', () => {
      const s = PREV_SHORT.dataset.plain || 'Generate';
      const l = PREV_LONG.dataset.plain || 'Generate';
      qs('#shortDisc').value = s;
      qs('#longDisc').value = l;
      modalClose();
    });

    /*************** Boot ***************/
    (async () => {
      await openDB();
      populateCoreEnhancedSelect();
      resetForm();
      await refreshTable();
    })();
  </script>
</body>
</html>
